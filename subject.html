<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Details</title>
    <link rel="stylesheet" href="subject.css">
</head>
<body>
    <header>
        <h1 id="subject-title">Loading...</h1>
        <label class="toggle">
            <input type="checkbox" id="dark-mode-toggle" />
            <span class="slider">
                <span class="icon moon">&#x2600;</span>
                <span class="icon sun">&#x2600;</span>
            </span>
        </label>
    </header>
    <div id="questions-container"></div>
    <div id="floating-buttons">
        <button id="reshuffle-questions">
            <span class="icon">&#x21bb;</span>
        </button>
    </div>
    <br><br><br>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
    $(document).ready(function () {
        const { category, subject } = getQueryParams();

        if (category && subject) {
            // Set the title
            $("#subject-title").text(`${category} - ${subject}`);

            // Fetch questions and display them
            fetchQuestions(subject)
                .done((data) => {
                    const $container = $("#questions-container");
                    displayQuestions(data.questions);  // Initially display questions
                    data.questions = data.questions; // Store the original questions to reshuffle
                    // Attach reshuffle button handler
                    const $reshuffleButton = $("#reshuffle-questions");
                    $reshuffleButton.on('click', function() {
                        reshuffleQuestions(data.questions); // Trigger reshuffle
                        $reshuffleButton.addClass("spinning");
                        setTimeout(() => $reshuffleButton.removeClass("spinning"), 500);
                    });
                })
                .fail(() => {
                    $("#questions-container").html(
                        "<p>Could not load questions. Please try again later.</p>"
                    );
                });
        } else {
            $("#subject-title").text("Invalid Subject");
            $("#questions-container").html(
                "<p>No subject data found. Please go back and select a valid subject.</p>"
            );
        }

        // Attach dark mode toggle handler
        setupDarkModeToggle();
    });

    // Parse query parameters from the URL
    function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            category: params.get("category"),
            subject: params.get("subject"),
        };
    }

    function fetchQuestions(subject) {
        const formattedSubject = subject
            .toLowerCase()
            .replace(/\s+/g, "_")
            .replace(/[^\w\(\)żółćęśąźń]/gi, "");

        const jsonFileName = `subjects/${formattedSubject}.json`;

        return $.getJSON(jsonFileName).done(function (data) {
            displayQuestions(data.questions);
            displayCredits(data.credits);
        }).fail(function () {
            console.error("Failed to load JSON file:", jsonFileName);
        });
    }

    // Function to display questions with click-to-show answers
    function displayQuestions(questions) {
        const $container = $("#questions-container").empty();

        questions.forEach(q => {
            const $questionDiv = $("<div>").addClass("question").text(q.question);
            const $answerDiv = $("<div>")
                .addClass("answer")
                .text(q.answer)
                .hide();

            $questionDiv.on("click", function () {
                $answerDiv.slideToggle();
            });

            $container.append($questionDiv, $answerDiv);
        });
    }

    // Function to reshuffle questions
    function reshuffleQuestions(questions) {
        // Shuffle questions using a simple algorithm (Fisher-Yates shuffle)
        for (let i = questions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [questions[i], questions[j]] = [questions[j], questions[i]]; // Swap
        }

        displayQuestions(questions); // Re-display the shuffled questions
    }

    // Function to display credits in the bottom-right corner
    function displayCredits(credits) {
        if (!credits) return; // If no credits, do nothing

        let $creditsDiv = $("#credits"); // Check if #credits already exists
        if ($creditsDiv.length === 0) {
            $creditsDiv = $("<div>").attr("id", "credits").appendTo("body");
        }
        
        $creditsDiv.text(`Definitions by: ${credits}`);
    }

    // Setup dark mode toggle
    function setupDarkModeToggle() {
        $("#dark-mode-toggle").on("change", function () {
            $("body").toggleClass("dark-mode");

            if ($("body").hasClass("dark-mode")) {
                console.log("Dark mode enabled");
            } else {
                console.log("Dark mode disabled");
            }
        });
    }

    </script>
</body>
</html>
